<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - ValJTask</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 12px; }
        .task-list-item { 
            transition: all 0.2s; 
            border-left: 4px solid #0d6efd;
        }
        .task-list-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .vencida { border-left-color: #dc3545 !important; background-color: #fff5f5; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary shadow mb-4">
        <div class="container">
            <span class="navbar-brand fw-bold mb-0 h1"><i class="bi bi-grid-fill"></i> ValJTask</span>
            <button onclick="cerrarSesion()" class="btn btn-light btn-sm fw-bold text-primary">
                <i class="bi bi-box-arrow-right"></i> Salir
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="row g-4">
            
            <div class="col-md-4">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title mb-3 fw-bold text-primary">
                            <i class="bi bi-plus-circle"></i> Nueva Tarea
                        </h5>
                        <form id="taskForm">
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">TÃ­tulo</label>
                                <input type="text" id="titulo" class="form-control" placeholder="Ej: Taller de MatemÃ¡ticas" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">DescripciÃ³n</label>
                                <textarea id="descripcion" class="form-control" rows="2" placeholder="Detalles..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">Fecha de Entrega</label>
                                <input type="datetime-local" id="fecha_entrega" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 fw-bold">
                                Guardar Tarea
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card mt-3 bg-white">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Estado del Semestre</h6>
                        <h2 class="text-success fw-bold">4.5</h2>
                        <small class="text-muted">Promedio Actual</small>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-dark m-0">Mis Pendientes</h5>
                    <span class="badge bg-secondary">Actualizado hoy</span>
                </div>

                <div id="listaTareas" class="d-flex flex-col gap-3">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando tus tareas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = "/static/login.html";

        function formatearFecha(fechaISO) {
            if (!fechaISO) return "Sin fecha";
            const fecha = new Date(fechaISO);
            return fecha.toLocaleString('es-CO', { 
                day: '2-digit', month: 'short', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
        }

        function cerrarSesion() {
            localStorage.removeItem('token');
            window.location.href = "/static/login.html";
        }

        // --- CARGAR TAREAS (GET) ---
        async function cargarTareas() {
            const contenedor = document.getElementById('listaTareas');
            try {
                const response = await fetch('/tareas/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const tareas = await response.json();
                    contenedor.innerHTML = ''; // Limpiar spinner

                    if (tareas.length === 0) {
                        contenedor.innerHTML = `
                            <div class="alert alert-success text-center" role="alert">
                                Â¡Todo listo! No tienes tareas pendientes ðŸŽ‰
                            </div>`;
                        return;
                    }

                    tareas.forEach(tarea => {
                        // LÃ³gica de Vencimiento
                        const fechaLimite = new Date(tarea.fecha_entrega);
                        const hoy = new Date();
                        const esVencida = fechaLimite < hoy;
                        
                        // DiseÃ±o de la tarjeta
                        const tarjeta = document.createElement('div');
                        tarjeta.className = `card task-list-item mb-3 ${esVencida ? 'vencida' : ''}`;
                        
                        tarjeta.innerHTML = `
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1 fw-bold ${esVencida ? 'text-danger' : 'text-dark'}">
                                        ${tarea.titulo} 
                                        ${esVencida ? '<span class="badge bg-danger ms-2">Vencida</span>' : ''}
                                    </h5>
                                    <p class="card-text text-muted small mb-2">${tarea.descripcion}</p>
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-calendar-event"></i> ${formatearFecha(tarea.fecha_entrega)}
                                        </span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm" type="button">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        contenedor.appendChild(tarjeta);
                    });
                }
            } catch (error) {
                console.error(error);
                contenedor.innerHTML = '<div class="alert alert-danger">Error de conexiÃ³n</div>';
            }
        }

        // --- CREAR TAREA (POST) ---
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('titulo').value;
            const descripcion = document.getElementById('descripcion').value;
            const fecha = document.getElementById('fecha_entrega').value;

            try {
                const response = await fetch('/tareas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        titulo, descripcion, fecha_entrega: fecha 
                    })
                });

                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('titulo').value = '';
                    document.getElementById('descripcion').value = '';
                    document.getElementById('fecha_entrega').value = '';
                    cargarTareas(); // Recargar lista
                } else {
                    const error = await response.json();
                    alert("Error: " + (error.detail[0].msg || error.detail));
                }
            } catch (error) { console.error(error); }
        });

        // Iniciar
        cargarTareas();
    </script>
</body>
</html>